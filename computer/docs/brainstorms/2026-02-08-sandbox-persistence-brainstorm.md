# Sandbox Session Persistence & Workspaces

**Date:** 2026-02-08
**Status:** Brainstorm complete, ready for planning

---

## What We're Building

Fix sandbox mode so trust levels persist across messages, and sessions have full multi-turn conversation continuity. This is Phase 1 of a two-phase effort; Phase 2 adds user-facing workspace management UI and configurable mount scopes.

### The Bug

When a sandboxed chat sends its first message, the Docker container creates an internal SDK session ID. The orchestrator rewrites this to a canonical `sandbox_sid` and emits it to the client. But the session finalization writes to the DB in a way the session manager can't find on the next lookup:

```
WARNING - Unknown session ID requested: 0bb62b20-..., treating as new session
```

The second message creates a brand-new session with no trust level set, which defaults to `full`. The sandbox is silently dropped.

Additionally, the container is `--rm` and has no access to host `~/.claude/projects/`, so even if session lookup worked, the Claude CLI can't `--resume` — each message is a fresh conversation with no memory.

### Root Causes

1. **Session finalization mismatch** — The `sandbox_sid` generated by the orchestrator isn't being stored/looked up correctly in the DB
2. **No transcript persistence** — Container's JSONL transcript is lost on exit (`--rm`)
3. **No `--resume` capability** — Container can't see prior transcripts, so every message is a fresh SDK session

## Why This Approach (Approach D)

We evaluated four approaches:

| Approach | Verdict |
|----------|---------|
| A: Fix finalization + mount host `~/.claude/` | Security leak — sandboxed session could read all other sessions' transcripts |
| B: Mount only the specific JSONL file | Too complex — path construction, pre-creation, CLI directory structure replication |
| C: Move transcripts into vault | Doesn't work — we only mount a workspace folder, not the whole vault |
| **D: Per-session `.claude/` inside workspace** | **Chosen** — isolated, persistent, secure |

### How Approach D Works

1. Each sandboxed session gets a workspace folder: `vault/.workspaces/{workspace-name}/`
2. Inside the workspace, a `.claude/` directory stores the session's SDK transcripts
3. The container mounts the workspace and sets `HOME` so the CLI writes transcripts inside it
4. On follow-up messages, the same workspace is mounted — CLI finds transcripts — `--resume` works
5. No access to other sessions' data (true isolation)

### Resolution chain for a sandboxed follow-up message

```
App sends session_id → Server looks up in DB → Finds session with trust_level=sandboxed
  → Orchestrator spins up container with workspace mounted
  → Container HOME points into workspace → CLI finds .claude/projects/{session}.jsonl
  → --resume works → Full conversation continuity
```

## Key Decisions

1. **Full conversation continuity** in sandbox — not single-turn or summary-based
2. **User picks/creates workspaces** — not auto-generated per session
3. **Configurable mount scope** — default workspace-only, but allow broader vault access per session
4. **Two phases** — Phase 1 fixes persistence + transcript mounting; Phase 2 adds workspace UI
5. **Per-session `.claude/` inside workspace** — transcripts isolated per workspace, no host transcript leakage

## Phase 1 Scope (Next: `/workflows:plan`)

- Fix session DB finalization so `sandbox_sid` is correctly stored and retrievable
- Fix `get_or_create_session` to find existing sandboxed sessions
- Ensure `trust_level` is preserved on the finalized session row
- Mount workspace `.claude/` directory into the container
- Set container `HOME` so CLI transcript paths resolve inside the mount
- Pass `--resume` with the correct session ID for follow-up messages
- Auto-create a default workspace for sandboxed sessions (until Phase 2 adds UI)

## Phase 2 Scope (Future)

- Workspace management UI in the app (create, select, list)
- Configurable mount scope per session (workspace-only vs workspace-rw + vault-ro)
- Multiple sessions sharing a workspace
- Workspace-level settings and permissions

## Open Questions

- What should the default workspace be named for auto-created sandboxed sessions? (e.g., `sandbox-{session-short-id}`, or a single `default` workspace?)
- Should the `.claude/` directory inside the workspace be hidden from the AI's file access? (It contains session metadata the AI probably shouldn't modify)
- How does the container's `HOME` interact with other CLI expectations (config, credentials)?
