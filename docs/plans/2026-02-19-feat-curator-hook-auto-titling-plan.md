---
title: "feat: Curator hook — auto-title sessions with Haiku"
type: feat
date: 2026-02-19
issue: "#61"
---

# Curator Hook: Auto-Title Sessions with Haiku

## Overview

Enable the existing `activity_hook.py` so that chat sessions get intelligent, evolving titles generated by Haiku instead of being stuck with the first line of the user's first message. Add cadence control so the hook doesn't fire on every turn, and a `title_source` field so the hook respects user-renamed titles.

**Scope:** Titles only. Activity logging already works in the hook — we're just enabling and refining the title path.

## Problem Statement

Session titles are currently set once via `generate_title_from_message()`, which takes the first line of the user's first message and truncates it. A session that starts with "hey can you help me" keeps that title forever, even if it turns into a 50-message debugging session about authentication. This makes the session list useless for finding past conversations.

The code to fix this already exists in `computer/parachute/hooks/activity_hook.py` — it reads the transcript, calls Haiku, and updates the title. It's just never been turned on.

## Proposed Solution

Three changes, all small:

1. **Configure the hook** in `.claude/settings.json` so the SDK fires it on `Stop`
2. **Add cadence control** so Haiku isn't called on every single message
3. **Track title source** so the hook doesn't overwrite user-edited titles

## Technical Approach

### How it works today (disabled)

```
SDK fires Stop event
  → spawns `python -m parachute.hooks.activity_hook`
  → hook reads stdin JSON: { transcript_path, session_id }
  → reads last exchange from transcript JSONL
  → calls Haiku via query_streaming() with summarizer prompt
  → parses "SUMMARY: ..." and "TITLE: ..." from response
  → updates session title in SQLite if title != NO_CHANGE
  → appends entry to Daily/.activity/{date}.jsonl
```

This flow is already implemented. The hook just isn't configured.

### Change 1: Enable the hook

**File:** `.claude/settings.json`

Add the `Stop` hook configuration:

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  },
  "hooks": {
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "python -m parachute.hooks.activity_hook"
          }
        ]
      }
    ]
  }
}
```

**Important:** The hook runs as a separate process spawned by the Claude Code SDK after each assistant turn. It receives hook input as JSON on stdin. This is the Claude Code CLI hook system — not the Parachute application hook system (`HookRunner`).

**Sandbox sessions:** The SDK fires `Stop` hooks for all sessions, including sandboxed ones. The `transcript_path` in the hook input points to the host filesystem (the SDK writes transcripts before the hook fires). For sandboxed sessions, the orchestrator writes a synthetic transcript at `vault/.parachute/sandbox/{slug}/.claude/` — verify the hook can access this path.

### Change 2: Cadence control

Don't call Haiku on every exchange. Use a simple schedule based on exchange number:

| Exchange # | Fire hook? | Rationale |
|-----------|-----------|-----------|
| 1 | Yes | Replace generic "first line" title with something meaningful |
| 2 | No | Too soon, title from #1 is probably fine |
| 3 | Yes | Conversation direction is clearer now |
| 5 | Yes | Mid-conversation check |
| 10, 20, 30... | Yes (every 10th) | Long sessions: periodic refresh |

**Implementation:** Check exchange number in the hook before calling Haiku. The hook already counts exchanges via `read_last_exchange()` which returns `exchange_number`.

```python
# activity_hook.py — add at top of handle_stop_hook(), after reading exchange

TITLE_UPDATE_EXCHANGES = {1, 3, 5}  # Always fire on these
TITLE_UPDATE_INTERVAL = 10          # After 5, fire every 10th

exchange_num = exchange.get("exchange_number", 1)
should_update_title = (
    exchange_num in TITLE_UPDATE_EXCHANGES
    or (exchange_num > 5 and exchange_num % TITLE_UPDATE_INTERVAL == 0)
)
```

When `should_update_title` is False, the hook still logs activity but skips the Haiku call. This keeps the activity log complete while minimizing API costs.

**Why not debounce/time-based?** The hook is a separate process with no persistent state between invocations. Exchange number is available from the transcript and requires no external state.

### Change 3: Track title source

Add a `title_source` field to session metadata so the hook can detect user-renamed titles.

**File:** `computer/parachute/models/session.py`

No schema change needed — `metadata` is already a flexible JSON dict. We'll use a convention:

```python
metadata = {
    "title_source": "default" | "ai" | "user"
}
```

- `"default"` — set by `generate_title_from_message()` (current behavior)
- `"ai"` — set by the curator hook
- `"user"` — set when user explicitly renames via the app

**Where to set it:**

| Location | Sets `title_source` to | File |
|----------|----------------------|------|
| `generate_title_from_message()` callsites | `"default"` | `orchestrator.py:887,1015,1183` |
| `activity_hook.py` after title update | `"ai"` | `activity_hook.py:122` |
| App title rename (PATCH /sessions/:id) | `"user"` | `api/sessions.py` — the endpoint that handles title updates from the app |

**Hook logic:** Before calling Haiku, check `title_source`:

```python
session = await db.get_session(session_id)
if session and session.metadata and session.metadata.get("title_source") == "user":
    # User renamed this session — don't overwrite
    # Still log activity, just skip title generation
    ...
```

### Files to modify

| File | Change |
|------|--------|
| `.claude/settings.json` | Add `hooks.Stop` configuration |
| `computer/parachute/hooks/activity_hook.py` | Add cadence control, check `title_source`, set `title_source` on update |
| `computer/parachute/core/orchestrator.py` | Set `metadata.title_source = "default"` at the 3 `finalize_session` callsites |
| `computer/parachute/api/sessions.py` | Set `metadata.title_source = "user"` when app sends title update |

### What we're NOT doing (YAGNI)

- **Not migrating to Parachute application hooks** — The SDK CLI hook works. The orchestrator doesn't fire Parachute hooks for session events yet. Wiring that up is a bigger change that can happen later.
- **Not adding per-workspace hook config** — All sessions get the same hook. Workspace-specific hooks can come later.
- **Not adding UI indicators** — No "auto-titled" badge. Keep it invisible. Users will just notice their titles are better.
- **Not adding structured output** — The text parsing for `SUMMARY:` / `TITLE:` works fine. If it breaks, we'll fix it then.
- **Not handling group chat specially** — The hook treats all sessions the same. Group titles may be less stable, but that's acceptable for MVP.
- **Not adding retry logic** — Fire-and-forget is fine. If the hook fails, the session keeps its current title. No harm done.
- **Not touching the summarizer session cache** — Daily session caching works as-is. Context limits are a theoretical concern that hasn't materialized.

## Acceptance Criteria

- [x] Hook fires after assistant turns (verified via activity log appearing in `vault/Daily/.activity/`)
- [x] New sessions get AI-generated titles after first exchange
- [x] Titles evolve as conversation progresses (check at exchange 3, 5, 10)
- [x] User-renamed titles are preserved (hook skips title update when `title_source == "user"`)
- [x] Hook doesn't call Haiku on every exchange (cadence control working)
- [x] Hook failures don't affect chat functionality (fire-and-forget, logged only)
- [x] Bot connector sessions (Telegram/Discord) also get auto-titled

## Testing

### Manual verification

1. Start a new chat, send a vague message like "hey help me with something"
2. Observe: title should update from "hey help me with something" to something meaningful after first response
3. Send 2 more messages — title should update at exchange 3
4. Manually rename the session in the app
5. Send another message — title should NOT be overwritten
6. Check `vault/Daily/.activity/{today}.jsonl` — activity entries should exist

### Edge cases to verify

- Very short session (1 exchange) — should still get a title
- Resumed session — hook should work, exchange count continues from transcript
- Bot session (if Telegram/Discord configured) — should get titles
- Concurrent sessions — both should get titled without errors

## References

- Brainstorm: `docs/brainstorms/2026-02-17-hooks-expansion-brainstorm.md`
- Existing hook: `computer/parachute/hooks/activity_hook.py`
- Hook runner: `computer/parachute/core/hooks/runner.py`
- Hook events: `computer/parachute/core/hooks/events.py`
- Session model: `computer/parachute/models/session.py`
- Orchestrator title generation: `computer/parachute/core/orchestrator.py:61-79`
- GitHub issue: #61
